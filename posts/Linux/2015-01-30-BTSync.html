<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-03-06 Mon 12:48 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BitTorrent Sync over SSH proxy</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Dominik Schrempf" />
<meta name="description" content="Use BitTorrent Sync over an SSH SOCKS Proxy"
 />
<meta name="keywords" content="BTSync, BitTorrent, Sync, SOCKS, Proxy, SSH" />
<link rel='stylesheet' href='/css/site.css' type='text/css'/>
<meta name="viewport" content="width=device-width"/>
</head>
<body>
<div id="preamble" class="status">
<div class='nav'>
<ul>
<li><a href='/'>Home</a></li>
<li><a href='/archive.html'>Archive</a></li>
<li><a href='http://github.com/dschrempf'>GitHub</a></li>
</ul>
</div>
</div>
<div id="content">
<h1 class="title">BitTorrent Sync over SSH proxy</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org62fbe2d">Introduction</a></li>
<li><a href="#org0fed06b">Setup of SSH tunnel</a></li>
<li><a href="#org1594d2a">BTSync setup</a></li>
</ul>
</div>
</div>
<p>
<span class="timestamp-wrapper"><span class="timestamp">&lt;2015-04-22 Wed&gt; </span></span> I have switched from BitTorrent Sync to <a href="https://syncthing.net/">Syncthing</a>.
Reasons are:
</p>
<ul class="org-ul">
<li>the synchronization was not reliable (synchronization stalled
sometimes; every update leads to a re-synchronization of all files);</li>
<li>the corporate policy is not to my liking (a Pro version is
available; the free version only supports a limited amount of
folders and clients; it is not sure if it will stay free in the
future).</li>
</ul>
<p>
Please also refer to the blog entry that describes how to configure
<a href="2015-04-22-Syncthing.html">Syncthing with SSH port forwarding</a>.
</p>

<div id="outline-container-org62fbe2d" class="outline-2">
<h2 id="org62fbe2d">Introduction</h2>
<div class="outline-text-2" id="text-org62fbe2d">
<p>
<span class="timestamp-wrapper"><span class="timestamp">&lt;2015-01-30 Fri&gt; </span></span> <a href="http://www.getsync.com/">BitTorrent Sync</a> is a nice program that lets you sync
two clients using advanced peer-to-peer technology.  It can be a very
good replacement for Dropbox if you do not want to share files with
others (although you could still use Dropbox for file sharing with
others).  Especially so, because it does not save any of your data on
a server and synchronization is encrypted.  Furthermore, it can be
installed very easily on Linux (and even on a Mac and on Windows).
Please see the installation instructions on their homepage.
</p>

<p>
The problem I had is that one of my clients (say client A) is behind a
firewall.  In order to circumvent it, we need a client B that has full
access to the internet and that is accessible by client A; then we ca
set up an SSH SOCKS proxy; check it out.
</p>


<div class="figure">
<p><img src="firewall-ssh-proxy.png" alt="firewall-ssh-proxy.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org0fed06b" class="outline-2">
<h2 id="org0fed06b">Setup of SSH tunnel</h2>
<div class="outline-text-2" id="text-org0fed06b">
<p>
In order for this to work, you need SSH access from client A to client
B.  Client B needs to have access to the internet.  Then you can setup
a dynamic SSH tunnel at client A with:
</p>
<div class="org-src-container">
<pre class="src src-sh">ssh -vvv -N -D 1080 username@clientB
</pre>
</div>
<dl class="org-dl">
<dt><code>-vvv</code></dt><dd>Increase verbosity to a high level, so that you can debug
problems if you have any (can be removed later).</dd>
<dt><code>-N</code></dt><dd>Do not open an interactive session (no commands can be
entered at prompt).</dd>
<dt><code>-D 1080</code></dt><dd>Dynamically forward all requests to <code>localhost:1080</code> to
client B (act as a SOCKS proxy on port 1080; if you are
interested please see, e.g., <a href="https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding">port forwarding</a>).</dd>
</dl>

<p>
If this worked out, every process on client A that accesses
<code>localhost:1080</code> will be forwarded to client B that is outside the
firewall.  I.e., you could also tell Firefox to use this SOCKS proxy
so that you can access sites that you cannot otherwise.  Actually this
is a very good idea to test if the SOCKS proxy works in general.
</p>
</div>
</div>

<div id="outline-container-org1594d2a" class="outline-2">
<h2 id="org1594d2a">BTSync setup</h2>
<div class="outline-text-2" id="text-org1594d2a">
<p>
Now, BTSync should automatically find this SOCKS proxy (because it is
using the standard port 1080; my BTSync version is <code>1.4.106</code>) and uses
it to circumvent the firewall.  The very good and informative debug
output of the SSH tunnel can be used to identify possible problems.  A
sample configuration file looks like this:
</p>

<p>
<span class="timestamp-wrapper"><span class="timestamp">&lt;2015-04-01 Wed&gt; </span></span> The automatic detection of the SOCKS proxy did not
work anymore (BTSync version <code>2.0.93</code>).  I have adjusted the
configuration file below.
</p>

<div class="org-src-container">
<pre class="src src-java">{
  <span style="color: #CC9393;">"device_name"</span> : <span style="color: #CC9393;">"username@clientA"</span>,
  <span style="color: #CC9393;">"listening_port"</span> : 0, <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">0 - randomize port.</span>

  <span style="color: #5F7F5F;">/* </span><span style="color: #7F9F7F;">The storage_path dir contains auxilliary app files if no</span>
<span style="color: #7F9F7F;">   storage_path field: .sync dir created in the directory where binary</span>
<span style="color: #7F9F7F;">   is located. otherwise user-defined directory will be used. */</span>
  <span style="color: #CC9393;">"storage_path"</span> : <span style="color: #CC9393;">"/home/username/.btsync"</span>,

  <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Set location of pid file.</span>
  <span style="color: #CC9393;">"pid_file"</span> : <span style="color: #CC9393;">"/home/username/.btsync/btsync.pid"</span>,

  <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Do not use UPnP for port mapping.</span>
  <span style="color: #CC9393;">"use_upnp"</span> : <span style="color: #BFEBBF;">false</span>,

  <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">limits in kB/s. 0 - no limit.</span>
  <span style="color: #CC9393;">"download_limit"</span> : 0,
  <span style="color: #CC9393;">"upload_limit"</span> : 0,

  <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Proxy configuration</span>
  <span style="color: #CC9393;">"proxy_type"</span> : <span style="color: #CC9393;">"socks4"</span>, <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Valid types: "socks4", "socks5", "http_connect". Any other value means no proxy</span>
  <span style="color: #CC9393;">"proxy_addr"</span> : <span style="color: #CC9393;">"127.0.0.1"</span>, <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">IP address of proxy server.</span>
  <span style="color: #CC9393;">"proxy_port"</span> : 1080,

  <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Do not use the webui.</span>
  <span style="color: #CC9393;">"webui"</span> :
  {
    <span style="color: #CC9393;">"listen"</span> : <span style="color: #CC9393;">"0.0.0.0:8889"</span>
  },

  <span style="color: #5F7F5F;">/* </span><span style="color: #7F9F7F;">!!! If you set shared folders in config file WebUI will be</span>
<span style="color: #7F9F7F;">  DISABLED !!!  Shared directories specified in config file override</span>
<span style="color: #7F9F7F;">  the folders previously added from WebUI. */</span>

  <span style="color: #CC9393;">"shared_folders"</span> :
  [
    {
      <span style="color: #CC9393;">"secret"</span> : <span style="color: #CC9393;">"MYSECRET"</span>, <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">required field - use --generate-secret in command line to create new secret</span>
      <span style="color: #CC9393;">"dir"</span> : <span style="color: #CC9393;">"/home/username/BTSync"</span>, <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">* required field</span>
      <span style="color: #CC9393;">"use_relay_server"</span> : <span style="color: #BFEBBF;">true</span>, <span style="color: #5F7F5F;">//  </span><span style="color: #7F9F7F;">use relay server when direct connection fails</span>
      <span style="color: #CC9393;">"use_tracker"</span> : <span style="color: #BFEBBF;">true</span>,
      <span style="color: #CC9393;">"use_dht"</span> : <span style="color: #BFEBBF;">false</span>,
      <span style="color: #CC9393;">"search_lan"</span> : <span style="color: #BFEBBF;">true</span>,
      <span style="color: #CC9393;">"use_sync_trash"</span> : <span style="color: #BFEBBF;">true</span>, <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">enable SyncArchive to store files deleted on remote devices</span>
      <span style="color: #CC9393;">"overwrite_changes"</span> : <span style="color: #BFEBBF;">false</span>, <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">restore modified files to original version, ONLY for Read-Only folders</span>
      <span style="color: #CC9393;">"known_hosts"</span> : <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">specify hosts to attempt connection without additional search</span>
      [
      ]
    }
  ]
}
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id='disqus_thread'></div>
<script>
    var disqus_config = function () {
        this.page.identifier = '(BitTorrent Sync over SSH proxy)';
    };
    (function() {
        var d = document, s = d.createElement('script');

        s.src = '//dschrempf.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href='https://disqus.com/?ref_noscript' rel='nofollow'>comments powered by Disqus.</a></noscript><div class='footer'>
Copyright 2015-2017 Dominik Schrempf<br/>
Last updated <span class="timestamp-wrapper"><span class="timestamp">2017-03-06</span></span><br/>
Built with <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.1 (<a href="http://orgmode.org">Org</a> mode 9.0.5) <br/>
<a href="http://validator.w3.org/check?uri=referer">Validate</a> HTML
</div>
<script type='text/javascript'>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-57993874-1', 'auto');
 ga('send', 'pageview');

</script>
</div>
</body>
</html>
