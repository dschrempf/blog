<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>A Simple MCMC Simulation</title>
<!-- 2015-03-23 Mon 18:15 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Dominik Schrempf" />
<meta  name="description" content="MCMC simulation to approximate observations of coin tosses."
 />
<meta  name="keywords" content="MCMC, Simulation, Bayesian Statistics, Coin Toss" />
<link rel='stylesheet' href='/css/site.css' type='text/css'/>
<meta name="viewport" content="width=device-width"/>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<div id="preamble" class="status">
<div class='nav'>
<ul>
<li><a href='/'>Home</a></li>
<li><a href='/archive.html'>Archive</a></li>
<li><a href='http://github.com/fazky'>GitHub</a></li>
</ul>
</div>
</div>
<div id="content">
<h1 class="title">A Simple MCMC Simulation</h1>
<p>
<span class="timestamp-wrapper"><span class="timestamp">&lt;2015-01-15 Thu&gt; </span></span> Suppose we observe 58 heads out of 100 coin tosses.
Now, we want to know the probability of tossing a head \(\theta\).  A
maximum likelihood guess would be \(\theta = 0.58\) because then, the
probability of observing 58 heads
</p>
\begin{align}
  P(58 \mathrm{ heads}) = {100 \choose 58} (0.58)^{58} (0.42)^{42}
\end{align}
<p>
is greatest (an example of the binomial distribution).
</p>

<p>
However, we could also use a Bayesian approach to calculate the
posterior distribution of the probability \(\theta\) (i.e., the
probability that \(\theta\) is a certain value conditioned on our
observation).
</p>

<p>
The following C++ code does exactly this (the last column is the posterior).
</p>

<div class="org-src-container">

<pre class="src src-C++"><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;iostream&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;iomanip&gt;</span>

<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;math.h&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;gsl/gsl_rng.h&gt;</span>

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Run a coin toss MCMC simulation.</span>

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">User interface.</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Observation.</span>
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">n_tosses</span> = 100;
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">n_heads</span>  = 58;
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">n_tails</span>  = n_tosses - n_heads;

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">MCMC settings.</span>
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">n_iter</span>      = 10000;
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">print_every</span> = 500;
<span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">delta</span>    = 0.1;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">fix_width_cout_str</span> (<span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> <span style="color: #BA36A5;">s</span>)
{
    <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #D0372D;">std</span>::setw(10) &lt;&lt; <span style="color: #D0372D;">std</span>::fixed &lt;&lt; <span style="color: #D0372D;">std</span>::setprecision(2)&lt;&lt; s &lt;&lt; <span style="color: #008000;">"  "</span>;
}

<span style="color: #6434A3;">void</span> <span style="color: #006699;">fix_width_cout_dbl</span> (<span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">d</span>)
{
    <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #D0372D;">std</span>::setw(10) &lt;&lt; <span style="color: #D0372D;">std</span>::fixed &lt;&lt; <span style="color: #D0372D;">std</span>::setprecision(2)&lt;&lt; d &lt;&lt; <span style="color: #008000;">"  "</span>;
}

<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span> (<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">argc</span>, <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">argv</span>[])
{
    <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">gsl_rng_type</span> * <span style="color: #BA36A5;">t</span>;
    <span style="color: #6434A3;">gsl_rng</span> * <span style="color: #BA36A5;">r</span>;
    <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">theta</span>;               <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">The probability of tossing a head.</span>
    <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">posterior</span>[100];           <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">The posterior.</span>

    gsl_rng_env_setup();

    t = gsl_rng_default;
    r = gsl_rng_alloc (t);
    gsl_rng_set (r, 1);

    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Pick a first guess from the prior distribution (uniform prior).</span>
    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Here, the prior does not really effect the posterior.  However,</span>
    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">it kicks in, when the likelihood ratio for acceptance is</span>
    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">calculated (see below).</span>
    theta = gsl_rng_uniform (r);

    <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"Start MCMC."</span> &lt;&lt; <span style="color: #D0372D;">std</span>::endl;

    fix_width_cout_str(<span style="color: #008000;">"iteration"</span>);
    fix_width_cout_str(<span style="color: #008000;">"theta_old"</span>);
    fix_width_cout_str(<span style="color: #008000;">"theta_pri"</span>);
    fix_width_cout_str(<span style="color: #008000;">"ln_tot"</span>);
    fix_width_cout_str(<span style="color: #008000;">"pr_of_acc"</span>);
    fix_width_cout_str(<span style="color: #008000;">"theta_new"</span>);
    <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #D0372D;">std</span>::endl;

    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Initialize posterior.</span>
    <span style="color: #0000FF;">for</span> (<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span> = 0; i &lt; 100; i++) {
        posterior[i] = 0.0;
    }

    <span style="color: #0000FF;">for</span> (<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span> = 0; i &lt; n_iter; i++)
        {
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Acceptance ratio.</span>
            <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">acc</span>;
            <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">ln_likelihood_ratio</span>;
            <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">ln_prior_ratio</span>;
            <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">ln_proposal_ratio</span>;
            <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">ln_tot</span>;

            <span style="color: #8D8D84;">//////////////////////////////</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Propose a new theta.</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Uniform, symmetric jump algorithm (Metropolis algorithm).</span>

            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">The jump algorithm influences the runtime (How many</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">proposals are accepted?) but it should not change the</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">posterior; this can be proven for the Metropolos and</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">the Metropolis-Hastings (non-symmetric jumps) algorithm.</span>
            <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">old_theta</span>   = theta;
            <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">rn</span>          = gsl_rng_uniform (r);
            <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">theta_prime</span> = theta + (rn - 0.5) * delta;

            <span style="color: #0000FF;">if</span> (theta_prime &lt; 0.0)
                theta_prime = - theta_prime;
            <span style="color: #0000FF;">if</span> (theta_prime &gt; 1.0)
                theta_prime = 2.0 - theta_prime;

            <span style="color: #8D8D84;">//////////////////////////////</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Accept theta_prime?</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Calculate the natural logarithm of the likelihood</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">ratios of the new proposal to the old one.  It consists</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">of:</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">1. The likelihood ratio due to the model.</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">2. The ratio of the prior (this is, where the prior</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">comes in).  If the likelihood ratio of the model is</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">flat (i.e., ln_likelihood_ratio ~= 0.0), the prior is</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">very informative; something that we do not want in</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">general.</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">3. The ratio of the proposal (the jumping algorithm).</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">This is, how we incorporate non-symmetric jumping</span>
            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">algorithms, so that they do not change the posterior.</span>
            ln_likelihood_ratio =
                (n_heads*log(theta_prime) + n_tails*log(1.0-theta_prime)) -
                (n_heads*log(theta) + n_tails*log(1.0-theta));
            ln_prior_ratio = 0.0;
            ln_proposal_ratio = 0.0;
            ln_tot = ln_likelihood_ratio + ln_prior_ratio + ln_proposal_ratio;

            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Circumvent underflow error.</span>
            <span style="color: #0000FF;">if</span> (ln_tot &lt; -300.0)
                acc = 0.0;
            <span style="color: #0000FF;">else</span> <span style="color: #0000FF;">if</span> (ln_tot &gt; 0.0)
                acc = 1.0;
            <span style="color: #0000FF;">else</span>
                acc = exp (ln_tot);

            <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Accept with probability acc.</span>
            <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">u</span> = gsl_rng_uniform (r);
            <span style="color: #0000FF;">if</span> (u &lt; acc)
                {
                    theta = theta_prime;
                    posterior[(<span style="color: #6434A3;">int</span>)(<span style="color: #6434A3;">theta</span>*100)] += 1.0;
                }

            <span style="color: #8D8D84;">//////////////////////////////</span>
            <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">Log results.</span>
            <span style="color: #0000FF;">if</span> (i % print_every == 0)
                {
                    fix_width_cout_dbl (i);
                    fix_width_cout_dbl (old_theta);
                    fix_width_cout_dbl (theta_prime);
                    fix_width_cout_dbl (ln_tot);
                    fix_width_cout_dbl (acc);
                    fix_width_cout_dbl (theta);
                    <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #D0372D;">std</span>::endl;
                }

        }

    <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"MCMC finished."</span> &lt;&lt; <span style="color: #D0372D;">std</span>::endl;
    <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #D0372D;">std</span>::endl;

    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Normalize posterior.</span>
    <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">sum</span> = 0.0;
    <span style="color: #0000FF;">for</span> (<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span> = 0; i &lt; 100; i++) {
        sum += posterior[i];
    }
    <span style="color: #0000FF;">for</span> (<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span> = 0; i &lt; 100; i++) {
        posterior[i] = posterior[i]/sum;
    }


    <span style="color: #0000FF;">for</span> (<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span> =0 ; i &lt; 100; i++) {
        <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"Theta between "</span>;
        <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #D0372D;">std</span>::setw(3) &lt;&lt; i;
        <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">" and "</span>;
        <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #D0372D;">std</span>::setw(3) &lt;&lt; i+1;
        <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">":\t"</span>;
        <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #D0372D;">std</span>::setw(4) &lt;&lt; <span style="color: #D0372D;">std</span>::setprecision(2) &lt;&lt; (posterior[i]);
        <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #D0372D;">std</span>::endl;
    }


    gsl_rng_free (r);

    <span style="color: #0000FF;">return</span> 0;
}
</pre>
</div>
</div>
<div id="postamble" class="status">
<div id='disqus_thread'></div>
<script type='text/javascript'>
  var disqus_shortname = 'Fazky'; // required: replace example with your forum shortname
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript><p>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></p></noscript><div class='footer'>
Copyright 2014 Dominik Schrempf<br/>
Last updated <span class="timestamp-wrapper"><span class="timestamp">2015-03-23</span></span><br/>
Built with <a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.4.1 (<a href="http://orgmode.org">Org</a> mode 8.3beta) <br/>
<a href="http://validator.w3.org/check?uri=referer">Validate</a> HTML
</div>
<script type='text/javascript'>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-57993874-1', 'auto');
 ga('send', 'pageview');

</script>
</div>
</body>
</html>
